#!/sbin/sh
# shellcheck shell=sh

umask 022
set -eu

# ────────── Константы ──────────
MIN_MAGISK_VER=20400

SOCIAL_LINKS="
Написать автору в Телеграм: https://t.me/avencores
Написать автору в VK:       https://vk.com/avencores

Ютуб канал:  https://youtube.com/@avencores
Рутуб канал: https://rutube.ru/channel/34072414
Дзен канал:  https://dzen.ru/avencores
Группа в ВК: https://vk.com/avencoresvk
"

# ────────── Аргументы update-binary ──────────
# Формат: <version> <OUTFD> <ZIPFILE>
EDIFY_API="${1:-}"
OUTFD="${2:-1}"
ZIPFILE="${3:-}"

# ────────── Вспомогательные функции ──────────
_raw_ui() {
  if [ -n "$OUTFD" ] 2>/dev/null; then
    # Просто выводим текст, recovery сам добавит ui_print при необходимости
    printf "%s\n" "$1" 1>&"$OUTFD" || printf "%s\n" "$1"
  else
    printf "%s\n" "$1"
  fi
}

ui_print() {
  # Безопасно и корректно обрабатываем многострочный аргумент.
  printf '%s' "$1" | while IFS= read -r _line || [ -n "$_line" ]; do
    _raw_ui "$_line"
  done
}

banner() {
  _raw_ui "*******************************"
  _raw_ui " $1 "
  ui_print "$SOCIAL_LINKS"
  _raw_ui "*******************************"
}

abort() {
  banner "${1:-Установка прервана}"
  exit 1
}

trap 'abort "Произошла ошибка во время установки"' INT TERM HUP QUIT
trap 'abort "Произошла ошибка во время установки"' ERR

# Определяем доступный менеджер root и проверяем его совместимость
detect_root_env() {
  # Magisk (основной путь API установки модулей)
  if [ -f /data/adb/magisk/util_functions.sh ]; then
    . /data/adb/magisk/util_functions.sh
    if [ "${MAGISK_VER_CODE:-0}" -lt "$MIN_MAGISK_VER" ]; then
      abort "Пожалуйста, установите Magisk v20.4+!"
    fi
    banner "Обнаружен Magisk. Продолжаем..."
  else
    # KernelSU / APatch — наличие окружения
    for entry in \
      "KernelSU:/data/adb/ksu/bin/ksud" \
      "APatch:/data/adb/apatch/apatchd"; do
      NAME=${entry%%:*}
      FILE=${entry#*:}
      if [ -f "$FILE" ]; then
        banner "Обнаружен $NAME. Продолжаем..."
        # Попробуем подключить util_functions, если присутствует
        [ -f /data/adb/magisk/util_functions.sh ] && . /data/adb/magisk/util_functions.sh || true
        break
      fi
    done
  fi

  # Проверим наличие install_module, иначе нет смысла продолжать
  if command -v install_module >/dev/null 2>&1; then
    return 0
  fi

  abort "Не найден API установки модулей (install_module).\n\nОткройте ZIP через приложение Magisk/KernelSU/APatch либо обновите окружение с поддержкой установки из recovery."
}

######################################
#                main               #
######################################

# Убедимся, что /data смонтирован (не критично, если нет)
mount /data 2>/dev/null || true

detect_root_env

# Продолжение установки модуля (функция предоставляется окружением recovery)
install_module
exit 0