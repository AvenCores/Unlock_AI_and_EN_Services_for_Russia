#!/sbin/sh

#################
# Initialization
#################

umask 022

# echo before loading util_functions
ui_print() { echo "$1"; }


# Проверка на форки Magisk, KernelSU и APatch
require_supported_env() {
  if [ -f /data/adb/magisk/util_functions.sh ]; then
    . /data/adb/magisk/util_functions.sh
    if [ $MAGISK_VER_CODE -lt 20400 ]; then
      ui_print "*******************************"
      ui_print " Пожалуйста, установите Magisk v20.4+! "
      ui_print "*******************************"
      exit 1
    fi
    return 0
  fi
  if [ -f /data/adb/ksu/bin/ksud ]; then
    ui_print "*******************************"
    ui_print " Обнаружен KernelSU. Продолжаем... "
    ui_print "*******************************"
    return 0
  fi
  if [ -f /data/adb/apatch/apatchd ]; then
    ui_print "*******************************"
    ui_print " Обнаружен APatch. Продолжаем... "
    ui_print "*******************************"
    return 0
  fi
  ui_print "*******************************"
  ui_print " Не найден поддерживаемый менеджер root (Magisk, KernelSU, APatch)! "
  ui_print "*******************************"
  exit 1
}

#########################
# Load util_functions.sh
#########################


OUTFD=$2
ZIPFILE=$3

mount /data 2>/dev/null

require_supported_env

install_module
exit 0
